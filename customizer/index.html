<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customizer | Big Head Billionaires</title>
  <link rel="icon" href="../assets/favicon.png"/>
  <link rel="stylesheet" href="../assets/bhb.css"/>
  <style>
    .page-header {
      margin-top: 62px;
      background: var(--blue);
      border-bottom: 4px solid var(--black);
      padding: 1.25rem 2rem;
    }
    .page-header h1 { font-family: var(--font-display); font-size: 2rem; color: var(--white); letter-spacing: 0.06em; line-height: 1; }
    .page-header p  { font-family: var(--font-mono); font-size: 0.76rem; color: rgba(255,255,255,0.65); margin-top: 0.3rem; }

    .customizer-wrap {
      display: grid;
      grid-template-columns: 270px 1fr 270px;
      height: calc(100vh - 62px - 70px);
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
    .trait-panel {
      border-right: 4px solid var(--black);
      overflow-y: auto;
      background: rgba(0,0,0,0.05);
    }
    .trait-panel::-webkit-scrollbar { width: 5px; }
    .trait-panel::-webkit-scrollbar-thumb { background: var(--black); border-radius: 3px; }

    .female-row {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: #ff4dab;
      border-bottom: 3px solid var(--black);
      cursor: pointer; user-select: none;
    }
    .female-row input[type=checkbox] { width:18px; height:18px; accent-color:var(--black); cursor:pointer; flex-shrink:0; }
    .female-row span { font-family:var(--font-display); font-size:0.9rem; color:var(--black); letter-spacing:0.06em; }

    .cat-block { border-bottom: 3px solid var(--black); }
    .cat-hd {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.55rem 1rem;
      background: var(--black);
      cursor: pointer; user-select: none;
    }
    .cat-hd-name { font-family:var(--font-display); font-size:0.82rem; color:var(--yellow); letter-spacing:0.1em; text-transform:uppercase; }
    .cat-hd-tag  { font-family:var(--font-mono); font-size:0.58rem; color:var(--red); letter-spacing:0.08em; }
    .cat-body { display:none; padding:0.7rem; }
    .cat-body.open { display:block; }
    .cat-current {
      display:flex; align-items:center; gap:0.65rem;
      background:rgba(255,255,255,0.45);
      border:2px solid var(--black); border-radius:6px;
      padding:0.45rem; margin-bottom:0.6rem;
    }
    .cat-thumb {
      width:50px; height:50px; flex-shrink:0;
      border:2px solid var(--black); border-radius:4px;
      overflow:hidden; background:rgba(0,0,0,0.08);
      display:flex; align-items:center; justify-content:center;
    }
    .cat-thumb img { width:100%; height:100%; object-fit:contain; image-rendering:pixelated; }
    .cat-info { flex:1; min-width:0; }
    .cat-name  { font-family:var(--font-display); font-size:0.78rem; color:var(--black); letter-spacing:0.04em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cat-count { font-family:var(--font-mono); font-size:0.58rem; color:rgba(0,0,0,0.4); }
    .cat-nav { display:flex; gap:0.4rem; }
    .cat-btn {
      flex:1; padding:0.38rem;
      font-family:var(--font-display); font-size:0.78rem; letter-spacing:0.04em;
      background:var(--black); color:var(--yellow);
      border:2px solid var(--black); border-radius:4px;
      cursor:pointer; transition:all 0.1s; text-align:center;
    }
    .cat-btn:hover  { background:var(--yellow); color:var(--black); }
    .cat-btn:active { transform:scale(0.95); }
    .cat-btn:disabled { opacity:0.3; cursor:not-allowed; }
    .cat-btn:disabled:hover { background:var(--black); color:var(--yellow); }

    /* ‚îÄ‚îÄ CENTER ‚îÄ‚îÄ */
    .canvas-stage {
      display:flex; align-items:center; justify-content:center;
      padding:1.25rem; overflow:hidden;
    }
    .canvas-wrap {
      position:relative;
      width: min(460px, calc(100vw - 2.5rem), calc(100vh - 62px - 70px - 2.5rem));
      aspect-ratio: 1 / 1;
      border:4px solid var(--black); border-radius:12px;
      overflow:hidden; box-shadow:var(--shadow-lg);
      background:#ccc;
    }
    #mainCanvas { position:absolute; inset:0; width:100%; height:100%; image-rendering:pixelated; }
    .load-overlay {
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(13,13,13,0.9); z-index:10; gap:0.9rem;
    }
    .load-title { font-family:var(--font-display); font-size:1.1rem; color:var(--yellow); letter-spacing:0.08em; }
    .load-bar   { width:200px; height:10px; background:rgba(255,255,255,0.12); border:2px solid var(--yellow); border-radius:999px; overflow:hidden; }
    .load-fill  { height:100%; background:var(--yellow); border-radius:999px; transition:width 0.2s; }
    .load-stat  { font-family:var(--font-mono); font-size:0.62rem; color:rgba(255,255,255,0.45); }

    /* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
    .save-panel {
      border-left:4px solid var(--black);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .save-hd {
      background:var(--red); border-bottom:3px solid var(--black);
      padding:0.65rem 1rem; flex-shrink:0;
      font-family:var(--font-display); font-size:0.95rem; color:var(--white); letter-spacing:0.06em;
    }
    .save-body {
      flex:1; overflow-y:auto; padding:0.9rem;
      display:flex; flex-direction:column; gap:0.4rem;
    }
    .save-body::-webkit-scrollbar { width:5px; }
    .save-body::-webkit-scrollbar-thumb { background:var(--black); border-radius:3px; }
    .sum-row {
      display:flex; justify-content:space-between; align-items:center;
      padding:0.3rem 0; border-bottom:1px dashed rgba(0,0,0,0.1);
      font-family:var(--font-mono); font-size:0.66rem;
    }
    .sum-row:last-child { border-bottom:none; }
    .sum-lbl { color:rgba(0,0,0,0.5); text-transform:uppercase; letter-spacing:0.05em; }
    .sum-val { color:var(--black); font-weight:600; text-align:right; max-width:130px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sum-val.anim { color:var(--blue); }

    .save-footer {
      padding:0.9rem; border-top:3px solid var(--black);
      display:flex; flex-direction:column; gap:0.65rem; flex-shrink:0;
    }
    .btn-full {
      width:100%; padding:0.65rem;
      font-family:var(--font-display); font-size:0.88rem; letter-spacing:0.06em; text-transform:uppercase;
      border:3px solid var(--black); border-radius:6px;
      cursor:pointer; box-shadow:var(--shadow-sm); transition:all 0.1s;
      text-align:center; text-decoration:none; display:block;
    }
    .btn-full:hover  { transform:translate(-2px,-2px); box-shadow:6px 6px 0 var(--black); }
    .btn-full:active { transform:translate(2px,2px);   box-shadow:2px 2px 0 var(--black); }
    .btn-full:disabled { opacity:0.4; cursor:not-allowed; pointer-events:none; transform:none; box-shadow:var(--shadow-sm); }
    .btn-yellow { background:var(--yellow); color:var(--black); }
    .btn-green  { background:var(--green);  color:var(--black); }
    .btn-black  { background:var(--black);  color:var(--yellow); }
    .btn-blue   { background:var(--blue);   color:var(--white); }

    /* ‚îÄ‚îÄ NFT Selector ‚îÄ‚îÄ */
    .nft-section {
      border: 3px solid var(--black);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 0.25rem;
    }
    .nft-section-hd {
      background: var(--black);
      padding: 0.45rem 0.75rem;
      font-family: var(--font-display);
      font-size: 0.72rem;
      color: var(--yellow);
      letter-spacing: 0.08em;
    }
    .nft-section-bd { padding: 0.6rem; background: rgba(255,255,255,0.5); }

    .nft-select {
      width: 100%;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      padding: 0.4rem 0.5rem;
      border: 2px solid var(--black);
      border-radius: 4px;
      background: var(--white);
      cursor: pointer;
      margin-bottom: 0.45rem;
    }
    .nft-card {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .nft-thumb {
      width: 44px; height: 44px; flex-shrink: 0;
      border: 2px solid var(--black); border-radius: 4px;
      overflow: hidden; background: #ccc;
    }
    .nft-thumb img { width:100%; height:100%; object-fit:cover; }
    .nft-meta { flex:1; min-width:0; }
    .nft-meta-name { font-family:var(--font-display); font-size:0.72rem; color:var(--black); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nft-meta-addr { font-family:var(--font-mono); font-size:0.55rem; color:rgba(0,0,0,0.4); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nft-status-msg {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      color: rgba(0,0,0,0.45);
      text-align: center;
      padding: 0.5rem;
      font-style: italic;
    }

    .save-progress {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      color: var(--blue);
      text-align: center;
      display: none;
    }
    .save-progress.visible { display: block; }

    @media (max-width:900px) {
      .customizer-wrap { grid-template-columns:1fr; grid-template-rows:auto auto auto; height:auto; overflow:visible; }
      .trait-panel { border-right:none; border-bottom:4px solid var(--black); max-height:400px; }
      .save-panel  { border-left:none;  border-top:4px solid var(--black); }
    }
  </style>
</head>
<body>

<nav class="bhb-nav">
  <a href="../index.html" class="logo">BIG HEAD <span>BILLIONAIRES</span></a>
  <ul class="nav-links">
    <li><a href="../game/index.html">Play &amp; Mint</a></li>
    <li><a href="../expansions/index.html">Expansions</a></li>
    <li><a href="index.html" class="active">Customizer</a></li>
    <li><a href="../animator/index.html">Animator</a></li>
    <li><a href="../episodes/index.html">Watch</a></li>
  </ul>
  <button class="nav-wallet-btn" id="walletBtn">Connect Wallet</button>
</nav>

<div class="page-header">
  <h1>üé® Character Customizer</h1>
  <p>Design your Big Head ‚Äî free for everyone. Connect your wallet to save traits on-chain to your NFT.</p>
</div>

<div class="customizer-wrap">

  <!-- LEFT -->
  <div class="trait-panel" id="traitPanel">
    <label class="female-row">
      <input type="checkbox" id="femaleToggle" onchange="toggleFemale()"/>
      <span>üë© Female Mode</span>
    </label>
    <!-- categories injected by JS -->
  </div>

  <!-- CENTER -->
  <div class="canvas-stage">
    <div class="canvas-wrap">
      <canvas id="mainCanvas" width="1000" height="1000"></canvas>
      <div class="load-overlay" id="loadOverlay">
        <div class="load-title">üçî Loading Assets...</div>
        <div class="load-bar"><div class="load-fill" id="loadFill" style="width:0%"></div></div>
        <div class="load-stat" id="loadStat">Starting...</div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="save-panel">
    <div class="save-hd">üçî Character Build</div>
    <div class="save-body" id="saveBody"></div>
    <div class="save-footer">

      <!-- NFT section ‚Äî shown only when wallet connected -->
      <div id="nftSection" style="display:none;">
        <div class="nft-section">
          <div class="nft-section-hd">üñº YOUR BHB NFTs</div>
          <div class="nft-section-bd">
            <select class="nft-select" id="nftSelect" onchange="onNftSelected()">
              <option value="">‚Äî Select NFT ‚Äî</option>
            </select>
            <div class="nft-card" id="nftCard" style="display:none;">
              <div class="nft-thumb"><img id="nftThumb" src="" alt="NFT"/></div>
              <div class="nft-meta">
                <div class="nft-meta-name" id="nftName">‚Äî</div>
                <div class="nft-meta-addr" id="nftAddr">‚Äî</div>
              </div>
            </div>
            <div class="nft-status-msg" id="nftStatusMsg">Loading your NFTs...</div>
          </div>
        </div>
      </div>

      <!-- No NFT message ‚Äî shown when wallet connected but no BHB NFTs -->
      <div id="noNftMsg" style="display:none;" class="nft-status-msg">
        No BHB NFTs found in this wallet.<br/>
        <a href="../game/index.html" style="color:var(--blue);">Play to Mint one ‚Üí</a>
      </div>

      <button class="btn-full btn-yellow" onclick="exportPNG()">üíæ Export PNG</button>
      <button class="btn-full btn-green" id="loadNftTraitsBtn" onclick="loadNftTraits()" style="display:none;">üì• Load NFT Traits</button>
      <button class="btn-full btn-blue"  id="saveToNftBtn"    onclick="saveToNft()"    style="display:none;" disabled>‚õì Save to NFT (100k BURG)</button>
      <div class="save-progress" id="saveProgress">Uploading...</div>
      <a href="../animator/index.html" class="btn-full btn-black">üé¨ Open in Animator ‚Üí</a>
    </div>
  </div>

</div>

<script src="../assets/bhb.js"></script>
<script type="module" src="../assets/mint.js?v=1772300058"></script>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  BHB CUSTOMIZER (CLEAN)
  //  - Uploads via backend (no JWT in browser)
  //  - Updates metadata via backend (holder signs intent)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const ASSET_BASE        = 'https://bhaleyart.github.io/BigHeadCharacterCooker';
  const COLLECTION_ADDR   = 'ECRmV6D1boYEs1mnsG96LE4W81pgTmkTAUR4uf4WyGqN';
  const HELIUS_DAS        = 'https://mainnet.helius-rpc.com/?api-key=a88e4b38-304e-407a-89c8-91c904b08491';

  const TRAITS = {
    EYES: { label:'Eyes', animated:true, files:[
      'Curious.png','Alien.png','Annoyed.png','Demonic.png','Diamond.png','Dots.png',
      'Grumpy.png','Hypnotized.png','Infuriated.png','Insect.png','Joy.png',
      'Light Bright.png','Monocle.png','Ouchy.png','Paranoid.png','Possessed.png',
      'Ruby Stare.png','Spider.png','Stare.png','Stoney Eyes.png','Sunglasses.png',
      'Surprised.png','Tears.png','Deceased.png','Too Chill.png','VR Headset.png',
      '3D Glasses.png','Blink.png','Stern.png','Tears.gif'
    ]},
    MOUTH: { label:'Mouth', animated:true, files:[
      'Mmm.png','Simpleton.png','Stache.png','Creeper.png','Pierced.png','Fangs.png',
      'Gold Teeth.png','Diamond Teeth.png','Birdy.png','Panic.png','Sss.png','Ahh.png',
      'Ehh.png','Uhh.png','LLL.png','Rrr.png','Fff.png','Ooo.png','Thh.png','Eee.png',
      'Haha.png','Rofl.png','Bean Frown.png','Bean Smile.png','Smirk.png','Bored.png',
      'Gas Mask.png','Scuba.png'
    ]},
    HEAD: { label:'Head / Hat', files:[
      'None.png','Antenna.png','Bandana Bro.png','Beanie.png','Blonde Beanie.png',
      'Blonde Bun.png','Blue Bedhead.png','Brain Squid.png','Bravo.png','Brunette Beanie.png',
      'Brunette Ponytail.png','Burger Crown.png','Captain Hat.png','Cat Hat.png',
      'Chad Bandana.png','Cherry Sundae.png','Clown Wig.png','Fancy Hat.png','Fireman.png',
      'Flame Princess.png','Fossilized.png','Gamer Girl.png','Ginger Ponytail.png',
      'Heated.png','Horny Horns.png','Hunted.png','Jester.png','Kingly.png','Mad Hatter.png',
      'Masked Up.png','Mohawk Blue.png','Mohawk Green.png','Mohawk Red.png','Mortricia.png',
      'Outlaw.png','Overload.png','Patrol Cap.png','Pharaoh Hat.png','Pink Pigtails.png',
      'Powdered Wig.png','Press Pass.png','Propeller.png','Rainbow Babe.png',
      'Recon Helmet.png','Robin Hood.png','Santa Hat.png','Sewer Slime.png',
      'Snapback Blue.png','Snapback Hippy.png','Snapback Red.png','Snapback Yellow.png',
      'Sombrero.png','Spiritual.png','Surgeon.png','UwU Kitty.png','Valhalla Cap.png',
      'Way Dizzy.png'
    ]},
    OUTFIT: { label:'Outfit', files:[
      'None.png','Blue Tee.png','Blueberry Dye.png','Degen Green.png','Degen Purple.png',
      'Earthy Dye.png','Hodl Black.png','Hodl White.png','Locked Up.png','Moto-X.png',
      'Orange Zip.png','Passion Dye.png','Pink Zip.png','Raider Ref.png','Red Tee.png',
      'Smally Bigs.png','Yellow Tee.png','Blue Zip.png','Red Zip.png','White Zip.png',
      'Hornet Zip.png','Ghostly Zip.png','Gold Jacket.png','Tuxedo.png','Thrashed.png',
      'The Fuzz.png','Pin Striped.png','Designer Zip.png','Luxury Zip.png','Explorer.png',
      'Power Armor.png','Shinobi.png','Thrilled.png','Trenches.png','Ski Jacket.png',
      'Sled Jacket.png','Commando.png','Space Cadet.png','Burgler.png','Commandant.png',
      'Golden Knight.png','Honey Bee.png','Necromancer.png','Paladin.png','Refined Suit.png',
      'Sexy Jacket.png','Stoner Hoodie.png','The Duke.png','Rave Hoodie.png',
      'Scuba suit temp.png','Burger Suit.png','Scrubs.png'
    ]},
    TEXTURE: { label:'Texture', files:[
      'None.png','Blood.png','Acid.png','Ink.png','Dart Frog Blue.png','Dart Frog Red.png',
      'Dart Frog Yellow.png','Magical.png','Puzzled.png','Rug Life Ink.png','Pulverized.png'
    ]},
    BODY: { label:'Body', files:[
      'Blank.png','Charcoal.png','High Voltage.png','Nebulous.png','Pinky.png',
      'Shockwave.png','Tangerine.png','Turquoise.png','Woody.png','Frogger.png',
      'Area 51.png','Dark Tone.png','Mid Tone.png','Light Tone.png','Jolly Roger.png',
      'Cyber Punk.png','Talking Corpse.png','Day Tripper.png','Meat Lover.png',
      'Golden God.png','Chrome Dome.png','Candy Gloss.png','Man On Fire.png','Water Boy.png',
      'Icecream Man.png','Reptilian.png','Juiced Up.png','Toxic Waste.png','Love Potion.png',
      'Pop Artist.png','Autopsy.png','Ghostly.png','Blue Screen.png','Networker.png'
    ]},
    BACKGROUNDS: { label:'Background', files:[
      'None.png','Natural.png','Mania.png','Regal.png','Lavish.png','Sunflower.png',
      'Snowflake.png','Bleach.png','Vibes.png','Burst.png','Aquatic.png','Passionate.png',
      'Envious.png','Enlightened.png','Haunted.png','Cursed.png'
    ]}
  };

  const FEMALE_LAYERS = {
    EYELASHES: { folder:'GIRL', files:['Eyelashes.png'] },
    BREASTS:   { folder:'GIRL', files:['Breasts.png'] }
  };

  const LAYER_ORDER = ['BACKGROUNDS','BODY','TEXTURE','OUTFIT','BREASTS','HEAD','MOUTH','EYELASHES','EYES'];

  const state = {
    indices:    {},
    images:     {},
    female:     false,
    nfts:       [],
    selectedNft: null,
  };

  Object.keys(TRAITS).forEach(cat => {
    const none = TRAITS[cat].files.findIndex(f => f.toLowerCase() === 'none.png');
    state.indices[cat] = none >= 0 ? none : 0;
    state.images[cat]  = [];
  });
  Object.keys(FEMALE_LAYERS).forEach(cat => {
    state.indices[cat] = 0;
    state.images[cat]  = [];
  });

  const canvas = document.getElementById('mainCanvas');
  const ctx    = canvas.getContext('2d');

  function base58Encode(bytes) {
    const alphabet = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
    let digits = [0];
    for (let i = 0; i < bytes.length; i++) {
      let carry = bytes[i];
      for (let j = 0; j < digits.length; j++) {
        const x = digits[j] * 256 + carry;
        digits[j] = x % 58;
        carry = (x / 58) | 0;
      }
      while (carry) {
        digits.push(carry % 58);
        carry = (carry / 58) | 0;
      }
    }
    for (let k = 0; k < bytes.length && bytes[k] === 0; k++) digits.push(0);
    return digits.reverse().map(d => alphabet[d]).join("");
  }

  async function preloadAll() {
    const fill = document.getElementById('loadFill');
    const stat = document.getElementById('loadStat');
    const jobs = [];
    Object.entries(TRAITS).forEach(([cat, def]) => {
      def.files.forEach((file, idx) => jobs.push({ cat, folder: cat, file, idx }));
    });
    Object.entries(FEMALE_LAYERS).forEach(([cat, def]) => {
      def.files.forEach((file, idx) => jobs.push({ cat, folder: def.folder, file, idx }));
    });

    let done = 0;
    const total = jobs.length;

    await Promise.all(jobs.map(({ cat, folder, file, idx }) =>
      new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = img.onerror = () => {
          state.images[cat][idx] = img.complete && img.naturalWidth ? img : null;
          fill.style.width = Math.round(++done / total * 100) + '%';
          stat.textContent  = `${done} / ${total}`;
          resolve();
        };
        img.src = `${ASSET_BASE}/${folder}/${encodeURIComponent(file)}`;
      })
    ));

    document.getElementById('loadOverlay').style.display = 'none';
    renderCharacter();
  }

  function renderCharacter() {
    ctx.clearRect(0, 0, 1000, 1000);
    for (const cat of LAYER_ORDER) {
      if (FEMALE_LAYERS[cat] && !state.female) continue;
      const img = state.images[cat]?.[state.indices[cat]];
      if (img) ctx.drawImage(img, 0, 0, 1000, 1000);
    }
    updateSummary();
  }

  function navigate(cat, dir) {
    const files = TRAITS[cat]?.files ?? FEMALE_LAYERS[cat]?.files ?? [];
    state.indices[cat] = Math.max(0, Math.min(files.length - 1, state.indices[cat] + dir));
    refreshCatUI(cat);
    renderCharacter();
  }

  function toggleFemale() {
    state.female = document.getElementById('femaleToggle').checked;
    renderCharacter();
  }

  function buildUI() {
    const panel = document.getElementById('traitPanel');
    while (panel.children.length > 1) panel.removeChild(panel.lastChild);

    Object.entries(TRAITS).forEach(([cat, def]) => {
      const el = document.createElement('div');
      el.className = 'cat-block';
      const tag = def.animated ? `<span class="cat-hd-tag">üé¨ Animated</span>` : '';
      el.innerHTML = `
        <div class="cat-hd" onclick="toggleCat('${cat}')">
          <span class="cat-hd-name">${def.label}</span>${tag}
        </div>
        <div class="cat-body" id="body-${cat}">
          <div class="cat-current">
            <div class="cat-thumb" id="thumb-${cat}"></div>
            <div class="cat-info">
              <div class="cat-name"  id="name-${cat}">‚Äî</div>
              <div class="cat-count" id="cnt-${cat}">‚Äî</div>
            </div>
          </div>
          <div class="cat-nav">
            <button class="cat-btn" id="prev-${cat}" onclick="navigate('${cat}',-1)">‚óÄ Prev</button>
            <button class="cat-btn" id="next-${cat}" onclick="navigate('${cat}', 1)">Next ‚ñ∂</button>
          </div>
        </div>`;
      panel.appendChild(el);
      refreshCatUI(cat);
    });
  }

  function toggleCat(cat) {
    document.getElementById(`body-${cat}`)?.classList.toggle('open');
  }

  function refreshCatUI(cat) {
    const files = TRAITS[cat]?.files ?? FEMALE_LAYERS[cat]?.files ?? [];
    const idx   = state.indices[cat] ?? 0;
    const img   = state.images[cat]?.[idx];
    const name  = (files[idx] ?? '‚Äî').replace(/\.(png|gif)$/i, '');
    const thumb = document.getElementById(`thumb-${cat}`);
    if (thumb) thumb.innerHTML = img ? `<img src="${img.src}" alt="${name}"/>` : '';
    const el = document.getElementById(`name-${cat}`);
    if (el) el.textContent = name;
    const cnt = document.getElementById(`cnt-${cat}`);
    if (cnt) cnt.textContent = `${idx + 1} / ${files.length}`;
    const prev = document.getElementById(`prev-${cat}`);
    if (prev) prev.disabled = idx === 0;
    const next = document.getElementById(`next-${cat}`);
    if (next) next.disabled = idx >= files.length - 1;
  }

  function updateSummary() {
    const body = document.getElementById('saveBody');
    body.innerHTML = '';

    if (state.nfts.length > 0) {
      const nftRow = document.createElement('div');
      nftRow.className = 'sum-row';
      const nftName = state.selectedNft ? state.selectedNft.content?.metadata?.name ?? 'BHB NFT' : 'None selected';
      nftRow.innerHTML = `<span class="sum-lbl">NFT</span><span class="sum-val" style="color:var(--blue);">${nftName}</span>`;
      body.appendChild(nftRow);
    }

    Object.entries(TRAITS).forEach(([cat, def]) => {
      const name = (def.files[state.indices[cat]] ?? '‚Äî').replace(/\.(png|gif)$/i,'');
      const row  = document.createElement('div');
      row.className = 'sum-row';
      row.innerHTML = `<span class="sum-lbl">${def.label}</span><span class="sum-val${def.animated?' anim':''}">${name}</span>`;
      body.appendChild(row);
    });

    if (state.female) {
      const row = document.createElement('div');
      row.className = 'sum-row';
      row.innerHTML = `<span class="sum-lbl">Style</span><span class="sum-val">Female</span>`;
      body.appendChild(row);
    }
  }

  function exportPNG() {
    const a = document.createElement('a');
    a.download = `BHB-${Date.now()}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
    BHB.toast('PNG exported!', 'success');
  }

  async function fetchOwnedBHBNfts(walletAddress) {
    try {
      const resp = await fetch(HELIUS_DAS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 'bhb-das',
          method: 'getAssetsByOwner',
          params: {
            ownerAddress: walletAddress,
            page: 1,
            limit: 1000,
            displayOptions: { showCollectionMetadata: true }
          }
        })
      });

      const json = await resp.json();
      const items = json.result?.items ?? [];

      return items.filter(asset => {
        const grouping = asset.grouping ?? [];
        return grouping.some(g => g.group_key === 'collection' && g.group_value === COLLECTION_ADDR);
      });
    } catch (e) {
      console.error('DAS fetch failed:', e);
      return [];
    }
  }

  async function onWalletConnected(walletAddress) {
    const nftStatusMsg = document.getElementById('nftStatusMsg');
    const nftSection   = document.getElementById('nftSection');
    const noNftMsg     = document.getElementById('noNftMsg');
    const nftSelect    = document.getElementById('nftSelect');
    const saveBtn      = document.getElementById('saveToNftBtn');
    const loadBtn      = document.getElementById('loadNftTraitsBtn');

    nftSection.style.display = 'block';
    nftStatusMsg.style.display = 'block';
    nftStatusMsg.textContent = 'Checking wallet for BHB NFTs...';
    document.getElementById('nftCard').style.display = 'none';

    const nfts = await fetchOwnedBHBNfts(walletAddress);
    state.nfts = nfts;

    if (nfts.length === 0) {
      nftSection.style.display = 'none';
      noNftMsg.style.display = 'block';
      saveBtn.style.display = 'none';
      loadBtn.style.display = 'none';
      return;
    }

    nftSelect.innerHTML = '<option value="">‚Äî Select NFT ‚Äî</option>';
    nfts.forEach((nft, i) => {
      const name = nft.content?.metadata?.name ?? `BHB #${i+1}`;
      const opt  = document.createElement('option');
      opt.value  = i;
      opt.textContent = name;
      nftSelect.appendChild(opt);
    });

    nftStatusMsg.textContent = `${nfts.length} BHB NFT${nfts.length > 1 ? 's' : ''} found ‚Äî select one below.`;
    saveBtn.style.display = 'block';
    loadBtn.style.display = 'block';
    updateSummary();
  }

  function onNftSelected() {
    const select  = document.getElementById('nftSelect');
    const idx     = select.value;
    const saveBtn = document.getElementById('saveToNftBtn');
    const loadBtn = document.getElementById('loadNftTraitsBtn');

    if (idx === '') {
      state.selectedNft = null;
      document.getElementById('nftCard').style.display = 'none';
      document.getElementById('nftStatusMsg').style.display = 'block';
      saveBtn.disabled = true;
      loadBtn.disabled = true;
      updateSummary();
      return;
    }

    state.selectedNft = state.nfts[Number(idx)];
    const nft  = state.selectedNft;
    const name = nft.content?.metadata?.name ?? 'BHB NFT';
    const addr = nft.id ?? '';
    const img  = nft.content?.links?.image ?? nft.content?.files?.[0]?.uri ?? '';

    document.getElementById('nftName').textContent = name;
    document.getElementById('nftAddr').textContent = addr.slice(0,4) + '...' + addr.slice(-4);
    document.getElementById('nftThumb').src = img;
    document.getElementById('nftCard').style.display = 'flex';
    document.getElementById('nftStatusMsg').style.display = 'none';

    saveBtn.disabled = false;
    loadBtn.disabled = false;
    updateSummary();
  }

  function loadNftTraits() {
    if (!state.selectedNft) return;
    const attrs = state.selectedNft.content?.metadata?.attributes ?? [];

    const traitMap = {
      'Eyes': 'EYES', 'Mouth': 'MOUTH', 'Head': 'HEAD', 'Head / Hat': 'HEAD',
      'Outfit': 'OUTFIT', 'Texture': 'TEXTURE', 'Body': 'BODY', 'Background': 'BACKGROUNDS'
    };

    let loaded = 0;
    attrs.forEach(attr => {
      const cat = traitMap[attr.trait_type];
      if (!cat) return;
      const files = TRAITS[cat]?.files ?? [];
      const match = files.findIndex(f => f.replace(/\.(png|gif)$/i,'').toLowerCase() === String(attr.value).toLowerCase());
      if (match >= 0) {
        state.indices[cat] = match;
        refreshCatUI(cat);
        loaded++;
      }
    });

    renderCharacter();
    BHB.toast(`Loaded ${loaded} traits from NFT!`, 'success');
  }

  // Upload is delegated to mint.js -> /api/pinata-upload (server-side JWT)
  async function uploadToArweave(blob, contentType) {
    if (!window.BHBMint?.uploadFile) throw new Error('BHBMint.uploadFile missing (mint.js not loaded)');
    return await window.BHBMint.uploadFile(blob, contentType);
  }

  function buildMetadata(nft, imageUrl) {
    const existing = nft.content?.metadata ?? {};
    return {
      name:        existing.name ?? 'Big Head Billionaire',
      symbol:      existing.symbol ?? 'BHB',
      description: existing.description ?? 'A Big Head Billionaire ‚Äî Play to Mint on Solana.',
      image:       imageUrl,
      external_url: 'https://bigheadbillionaires.vercel.app',
      attributes: [
        { trait_type: 'Background', value: TRAITS.BACKGROUNDS.files[state.indices.BACKGROUNDS]?.replace(/\.(png|gif)$/i,'') ?? 'None' },
        { trait_type: 'Body',       value: TRAITS.BODY.files[state.indices.BODY]?.replace(/\.(png|gif)$/i,'') ?? 'Blank' },
        { trait_type: 'Texture',    value: TRAITS.TEXTURE.files[state.indices.TEXTURE]?.replace(/\.(png|gif)$/i,'') ?? 'None' },
        { trait_type: 'Outfit',     value: TRAITS.OUTFIT.files[state.indices.OUTFIT]?.replace(/\.(png|gif)$/i,'') ?? 'None' },
        { trait_type: 'Head / Hat', value: TRAITS.HEAD.files[state.indices.HEAD]?.replace(/\.(png|gif)$/i,'') ?? 'None' },
        { trait_type: 'Mouth',      value: TRAITS.MOUTH.files[state.indices.MOUTH]?.replace(/\.(png|gif)$/i,'') ?? 'Mmm' },
        { trait_type: 'Eyes',       value: TRAITS.EYES.files[state.indices.EYES]?.replace(/\.(png|gif)$/i,'') ?? 'Curious' },
        { trait_type: 'Style',      value: state.female ? 'Female' : 'Male' },
      ],
      properties: {
        files:    [{ uri: imageUrl, type: 'image/png' }],
        category: 'image',
        creators: existing.properties?.creators ?? [{ address: '9eMPEUrH46tbj67Y1uESNg9mzna7wi3J6ZoefsFkivcx', share: 100 }]
      },
      collection: existing.collection ?? { name: 'Big Head Billionaires', family: 'BHB' }
    };
  }

  // ‚îÄ‚îÄ Save to NFT (upload + backend update) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveToNft() {
    if (!state.selectedNft) {
      BHB.toast('Select an NFT first.', 'error');
      return;
    }

    const btn      = document.getElementById('saveToNftBtn');
    const progress = document.getElementById('saveProgress');
    btn.disabled   = true;
    progress.classList.add('visible');

    try {
      // 1) Charge 100k BURG fee
      progress.textContent = 'üçî Sending 100,000 BURG fee... (approve in wallet)';
      await BHBMint.payBurgFee();

      // 2) Export canvas to blob
      progress.textContent = 'üì∏ Preparing image...';
      const imageBlob = await new Promise(res => canvas.toBlob(res, 'image/png'));

      // 3) Upload image
      progress.textContent = '‚òÅÔ∏è Uploading image...';
      const imageUrl = await uploadToArweave(imageBlob, 'image/png');
      console.log('Image uploaded:', imageUrl);

      // 4) Build + upload metadata JSON
      progress.textContent = 'üìã Uploading metadata...';
      const metadata     = buildMetadata(state.selectedNft, imageUrl);
      const metaBlob     = new Blob([JSON.stringify(metadata)], { type: 'application/json' });
      const metadataUrl  = await uploadToArweave(metaBlob, 'application/json');
      console.log('Metadata uploaded:', metadataUrl);

      // 5) Sign intent as HOLDER
      progress.textContent = '‚úçÔ∏è Signing update request...';

      const owner = (BHB?.walletAddress) || (window.solana?.publicKey?.toBase58?.() ?? '');
      if (!owner) throw new Error('Wallet address missing');

      const nonce = crypto.randomUUID();
      const message = JSON.stringify({
        action: "BHB_UPDATE_METADATA",
        owner,
        mint: state.selectedNft.id,
        metadataUri: metadataUrl,
        nonce,
      });

      const signed = await window.solana.signMessage(
        new TextEncoder().encode(message),
        "utf8"
      );

      const signature = base58Encode(signed.signature);

      // 6) Backend submits update as update authority
      progress.textContent = '‚õì Updating NFT on-chain...';

      const resp = await fetch("/api/update-metadata", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          owner,
          mint: state.selectedNft.id,
          metadataUri: metadataUrl,
          nonce,
          signature,
        }),
      });

      const out = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(out?.error || JSON.stringify(out));

      console.log("Update TX:", out.signature);

      // Update UI thumb
      document.getElementById('nftThumb').src = imageUrl;
      if (state.selectedNft?.content?.links) state.selectedNft.content.links.image = imageUrl;

      progress.textContent = '';
      progress.classList.remove('visible');
      btn.disabled = false;

      BHB.toast('üéâ NFT updated on-chain!', 'success');

    } catch (e) {
      console.error('Save to NFT failed:', e);
      progress.textContent = '';
      progress.classList.remove('visible');
      btn.disabled = false;
      BHB.toast('Save failed: ' + (e?.message ?? 'unknown error'), 'error');
    }
  }

  document.addEventListener('bhb:wallet-connected', async (e) => {
    const addr = e.detail?.address ?? BHB?.walletAddress;
    if (addr) await onWalletConnected(addr);
  });

  document.addEventListener('bhb:wallet-disconnected', () => {
    state.nfts        = [];
    state.selectedNft = null;
    document.getElementById('nftSection').style.display  = 'none';
    document.getElementById('noNftMsg').style.display    = 'none';
    document.getElementById('saveToNftBtn').style.display = 'none';
    document.getElementById('loadNftTraitsBtn').style.display = 'none';
    updateSummary();
  });

  window.addEventListener('load', async () => {
    await new Promise(r => setTimeout(r, 400));
    const addr = BHB?.walletAddress;
    if (addr) await onWalletConnected(addr);
  });

  buildUI();
  ['BODY','EYES'].forEach(c => document.getElementById(`body-${c}`)?.classList.add('open'));
  preloadAll();
</script>
</body>
</html>