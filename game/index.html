<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Play to Mint | Big Head Billionaires</title>
  <link rel="icon" href="../assets/favicon.png"/>
  <link rel="stylesheet" href="../assets/bhb.css"/>
  <style>
    .page-header {
      margin-top: 62px;
      background: var(--yellow);
      border-bottom: 4px solid var(--black);
      padding: 1.5rem 2rem;
    }
    .page-kicker { font-family: var(--font-body); font-size: 0.95rem; color: var(--red); margin-bottom: 0.2rem; }
    .page-header h1 { font-family: var(--font-display); font-size: 2.2rem; letter-spacing: 0.04em; line-height: 1; }
    .page-header p { font-family: var(--font-mono); font-size: 0.78rem; color: #444; margin-top: 0.35rem; }

    .game-layout {
      display: flex;
      gap: 2rem;
      padding: 2.5rem 2rem;
      max-width: 1050px;
      margin: 0 auto;
      align-items: flex-start;
    }

    /* ‚îÄ‚îÄ Game column: fixed 450px wide ‚îÄ‚îÄ */
    .game-column {
      flex: 0 0 450px;
    }

    .game-container {
      border: 3px solid var(--black);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .game-header {
      background: var(--black);
      padding: 0.7rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid var(--black);
    }
    .game-title { font-family: var(--font-display); font-size: 1rem; color: var(--yellow); letter-spacing: 0.08em; }
    .score-display { display: flex; gap: 1.5rem; }
    .score-block { text-align: right; }
    .score-lbl { font-family: var(--font-mono); font-size: 0.55rem; text-transform: uppercase; letter-spacing: 0.12em; color: rgba(255,255,255,0.4); }
    .score-val { font-family: var(--font-display); font-size: 1.4rem; color: rgba(255,255,255,0.4); line-height: 1; }
    .score-val.live { color: var(--yellow); }

    /* iframe wrapper ‚Äî exact game dimensions */
    .game-frame {
      width: 450px;
      height: 800px;
      display: block;
      background: #000;
      overflow: hidden;
    }

    .game-frame iframe {
      width: 450px;
      height: 800px;
      border: none;
      display: block;
    }

    .score-bar-wrap {
      padding: 1rem 1.25rem;
      border-top: 3px solid var(--black);
      background: var(--bg);
    }
    .score-bar-meta {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: #666;
      margin-bottom: 0.4rem;
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      min-width: 0;
    }

    .mint-panel { border: 3px solid var(--black); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-md); }
    .mint-panel-hd { background: var(--red); padding: 0.7rem 1.25rem; border-bottom: 3px solid var(--black); }
    .mint-panel-hd-title { font-family: var(--font-display); font-size: 1.1rem; color: var(--white); letter-spacing: 0.04em; }
    .mint-panel-bd { background: var(--bg-card); padding: 1.25rem; }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
      font-family: var(--font-mono);
      font-size: 0.73rem;
    }
    .detail-row:last-of-type { border-bottom: none; }
    .detail-lbl { color: #666; }
    .detail-val { color: var(--black); font-weight: 500; }
    .detail-val.hot { color: var(--red); font-weight: 700; }

    .mint-action { margin-top: 1.25rem; }

    .btn-locked {
      width: 100%;
      padding: 0.85rem;
      border-radius: 6px;
      border: 2px dashed rgba(0,0,0,0.2);
      background: #eee8d8;
      color: #aaa;
      font-family: var(--font-display);
      font-size: 0.95rem;
      letter-spacing: 0.06em;
      text-align: center;
      cursor: not-allowed;
    }
    .btn-locked .lk-icon { font-size: 1rem; display: block; }
    .btn-locked .lk-hint { font-family: var(--font-mono); font-size: 0.6rem; display: block; margin-top: 0.25rem; }

    .btn-mint {
      display: none;
      width: 100%;
      padding: 0.85rem;
      border-radius: 6px;
      border: 3px solid var(--black);
      background: var(--green);
      color: var(--black);
      font-family: var(--font-display);
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all 0.1s;
    }
    .btn-mint.visible { display: block; }
    .btn-mint:hover { transform: translate(-2px,-2px); box-shadow: 6px 6px 0 var(--black); }
    .btn-mint:active { transform: translate(2px,2px); box-shadow: 2px 2px 0 var(--black); }

    .rules-box { background: var(--bg-card); border: 3px solid var(--black); border-radius: 8px; padding: 1.25rem; box-shadow: var(--shadow-sm); }
    .rules-title { font-family: var(--font-display); font-size: 1rem; margin-bottom: 0.75rem; }
    .rules-list { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
    .rules-list li { font-family: var(--font-mono); font-size: 0.71rem; color: #555; padding-left: 1.1rem; position: relative; line-height: 1.5; }
    .rules-list li::before { content: '‚ñ∏'; position: absolute; left: 0; color: var(--red); }

    /* Mobile: stack game above sidebar */
    @media (max-width: 750px) {
      .game-layout { flex-direction: column; padding: 1rem; }
      .game-column { flex: none; width: 100%; }
      .game-frame, .game-frame iframe { width: 100%; height: auto; aspect-ratio: 9/16; }
    }
  </style>
</head>
<body>

<nav class="bhb-nav">
  <a href="../index.html" class="logo">BIG HEAD <span>BILLIONAIRES</span></a>
  <ul class="nav-links">
    <li><a href="index.html" class="active">Play &amp; Mint</a></li>
    <li><a href="../expansions/index.html">Expansions</a></li>
    <li><a href="../customizer/index.html">Customizer</a></li>
    <li><a href="../animator/index.html">Animator</a></li>
    <li><a href="../episodes/index.html">Watch</a></li>
  </ul>
  <button class="nav-wallet-btn" id="walletBtn">Connect Wallet</button>
</nav>

<div class="page-header">
  <div class="page-kicker">Step 1 of 5</div>
  <h1>üçî Play to Unlock Mint</h1>
  <p>Connect your wallet and mint a Big Head Billionaire. 5,000,000 BURG per mint.</p>
</div>

<main class="page" style="padding-top:0;">
  <div class="game-layout">

    <!-- Game column -->
    <div class="game-column">
      <div class="game-container">
        <div class="game-header">
          <span class="game-title">üçî BHB ARCADE üçî</span>
          <div class="score-display">
            <div class="score-block">
              <div class="score-lbl">Target</div>
              <div class="score-val live" id="scoreTarget">0</div>
            </div>
            <div class="score-block">
              <div class="score-lbl">Your Score</div>
              <div class="score-val" id="scoreCurrent">0</div>
            </div>
          </div>
        </div>

        <div class="game-frame">
          <iframe
            id="gameFrame"
            src="https://bhaleyart.github.io/burger_drop_mobile"
            allow="accelerometer; gyroscope"
            title="Burger Drop">
          </iframe>
        </div>

        <div class="score-bar-wrap">
          <div class="score-bar-meta">
            <span>Progress to unlock</span>
            <span id="progressPct">0%</span>
          </div>
          <div class="mint-progress">
            <div class="mint-progress-fill" id="scoreBar" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="mint-panel">
        <div class="mint-panel-hd">
          <div class="mint-panel-hd-title">üçî Mint Status üçî</div>
        </div>
        <div class="mint-panel-bd">
          <div class="detail-row"><span class="detail-lbl">Price</span><span class="detail-val hot">5,000,000 BURG</span></div>
          <div class="detail-row"><span class="detail-lbl">+ Network</span><span class="detail-val">~0.008 SOL</span></div>
          <div class="detail-row"><span class="detail-lbl">Supply</span><span class="detail-val">100 Total</span></div>
          <div class="detail-row"><span class="detail-lbl">Remaining</span><span class="detail-val hot" id="remaining">100</span></div>
          <div class="detail-row"><span class="detail-lbl">Limit</span><span class="detail-val">1 Per Wallet</span></div>

          <div class="mint-progress" style="margin-top:1rem;">
            <div class="mint-progress-fill" id="mintBar" style="width:0%"></div>
          </div>
          <div style="font-family:var(--font-mono); font-size:0.62rem; color:#888; margin-top:0.4rem;">
            <span id="mintedCount">0</span> / 100 Minted
          </div>

          <div class="mint-action">
            <div class="btn-locked" id="mintLocked">
              <span class="lk-icon">üîí</span>
              Mint Locked
              <span class="lk-hint">Mint available now</span>
            </div>
            <button class="btn-mint" id="mintUnlocked" onclick="handleMint()">
              üçî MINT NOW üçî
            </button>
          </div>
        </div>
      </div>

      <div class="rules-box">
        <div class="rules-title">The Rules</div>
        <ul class="rules-list">
          <li>Mint is available ‚Äî connect wallet to mint</li>
          <li>5,000,000 BURG tokens to mint</li>
          <li>Small SOL network fee (~$0.64)</li>
          <li>1 NFT per wallet, strictly enforced</li>
          <li>Only 100 exist, ever</li>
          <li>After mint ‚Üí Customizer to personalize</li>
        </ul>
      </div>

      <div class="rules-box" style="margin-top:1rem;">
        <div class="rules-title">üçî Get BURG Tokens</div>
        <div style="font-family:var(--font-mono); font-size:0.62rem; color:#888; margin:0.5rem 0 0.35rem; word-break:break-all;">
          CA: 6disLregVtZ8qKpTTGyW81mbfAS9uwvHwjKfy6LApump
        </div>
        <a href="https://pump.fun/coin/6disLregVtZ8qKpTTGyW81mbfAS9uwvHwjKfy6LApump"
           target="_blank"
           class="btn btn-black"
           style="display:block; text-align:center; font-size:0.78rem; padding:0.6rem 1rem; margin-top:0.5rem; text-decoration:none;">
          üçî Buy BURG on pump.fun ‚Üí
        </a>
      </div>
    </div>

  </div>
</main>

<script src="../assets/bhb.js"></script>
<script type="module" src="../assets/mint.js?v=1772303364"></script>
<script>
  const TARGET = 0;
  let unlocked = false;

  function updateScore(score) {
    const pct = 100; // Mint always unlocked
    document.getElementById('scoreCurrent').textContent = score.toLocaleString();
    document.getElementById('scoreCurrent').classList.toggle('live', score > 0);
    document.getElementById('scoreBar').style.width = pct + '%';
    document.getElementById('progressPct').textContent = Math.round(pct) + '%';
    if (score >= TARGET && !unlocked) unlockMint();
  }

  function unlockMint() {
    unlocked = true;
    console.log('[unlockMint] called');
    document.getElementById('mintLocked').style.display = 'none';
    document.getElementById('mintUnlocked').classList.add('visible');
    BHB.toast('üéâ Score reached! Mint unlocked.', 'success');
  }

  let _mintPrepped = false;
  let _minting     = false;

  async function _backgroundPrep(address) {
    if (_minting) return; // don't re-prep while a mint is in progress
    _mintPrepped = false;
    try {
      await BHBMint.initUmi(address);
      await BHBMint.prepMintTx();
      _mintPrepped = true;
      console.log('[game] mint ready');
    } catch(e) {
      console.error('[game] prep failed:', e.message, e);
    }
  }

  function handleMint() {
    console.log('[handleMint] called | walletAddress:', BHB.walletAddress, '| _mintPrepped:', _mintPrepped);
    if (!BHB.walletAddress) {
      // Just open wallet modal ‚Äî user must click button again after connecting
      BHB.connectWallet();
      return;
    }
    if (!_mintPrepped) {
      // Prep in background, show spinner ‚Äî user must click again once ready
      const btn = document.getElementById('mintUnlocked');
      btn.textContent = 'Preparing...';
      _backgroundPrep(BHB.walletAddress).then(() => {
        btn.textContent = 'üçî MINT NOW üçî';
        if (!_mintPrepped) BHB.toast('Could not prepare mint ‚Äî try again', 'error');
      });
      return;
    }
    // Transaction is pre-built ‚Äî call mint() immediately (no awaits before signTransaction)
    const btn = document.getElementById('mintUnlocked');
    btn.disabled = true;
    btn.textContent = 'Minting...';
    _mintPrepped = false;
    _minting = true;
    BHBMint.mint().then(stats => {
      _minting = false;
      BHB.toast('üéâ Mint successful! Check your wallet.', 'success');
      btn.textContent = '‚úÖ Minted!';
      document.getElementById('remaining').textContent   = stats.remaining;
      document.getElementById('mintedCount').textContent = stats.minted;
      document.getElementById('mintBar').style.width     = (stats.minted / 100 * 100).toFixed(0) + '%';
    }).catch(e => {
      const msg = e.message || '';
      BHB.toast(
        msg.includes('0x179')                                      ? 'Already minted ‚Äî 1 per wallet.'
        : msg.includes('cancelled') || msg.includes('rejected')   ? 'Transaction cancelled.'
        : msg.includes('insufficient lamports')                   ? 'Not enough SOL for fees.'
        : msg.includes('insufficient') || msg.includes('0x1')     ? 'Not enough BURG tokens.'
        : 'Mint failed: ' + msg, 'error'
      );
      _minting = false;
      btn.disabled = false;
      btn.textContent = 'üçî MINT NOW üçî';
      _backgroundPrep(BHB.walletAddress);
    });
  }

    // Pre-build mint tx when wallet connects so button click is gesture-synchronous
  // Unlock mint button immediately (TARGET=0, always available)
  document.addEventListener('DOMContentLoaded', async () => {
    unlockMint();
    const stats = await BHBMint.fetchStats().catch(() => null);
    if (stats) {
      document.getElementById('remaining').textContent   = stats.remaining;
      document.getElementById('mintedCount').textContent = stats.minted;
      document.getElementById('mintBar').style.width     = (stats.minted / 100 * 100).toFixed(0) + '%';
      if (stats.remaining === 0) {
        document.getElementById('mintUnlocked').textContent = 'üçî SOLD OUT üçî';
        document.getElementById('mintUnlocked').disabled = true;
      }
    }
  });

  document.addEventListener('bhb:wallet-connected', (e) => _backgroundPrep(e.detail?.address));

  window.addEventListener('message', e => {
    if (e.data?.type === 'bhb:score') updateScore(e.data.score);
  });
</script>
</body>
</html>